{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dash.css' %}">
{% endblock %}

{% block content %}

<!-- Dashboard Header -->
<!-- Stats Overview in Single Card -->
<div class="dashboard-section animate-on-scroll mb-5">
  <div class="section-header">
    <h2 class="section-title">
      <i class="fas fa-chart-bar me-2"></i>Overview
    </h2>
  </div>
  
  <div class="section-content">
    <div class="row g-4">
      <div class="col-md-3 col-6">
        <div class="stat-card-single zebra-stat-dark">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon-single">
              <i class="fas fa-gavel"></i>
            </div>
            <div class="stat-progress-single ms-auto">
              <div class="progress-bar-single" style="width: 85%"></div>
            </div>
          </div>
          <div class="stat-content-single">
            <h3 class="stat-value-single">{{ total_cases|default:"0" }}</h3>
            <p class="stat-label-single">Total Cases</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-6">
        <div class="stat-card-single zebra-stat-light">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon-single">
              <i class="fas fa-list-check"></i>
            </div>
            <div class="stat-progress-single ms-auto">
              <div class="progress-bar-single" style="width: 70%"></div>
            </div>
          </div>
          <div class="stat-content-single">
            <h3 class="stat-value-single">{{ total_stages|default:"0" }}</h3>
            <p class="stat-label-single">Total Stages</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-6">
        <div class="stat-card-single zebra-stat-dark">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon-single">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-progress-single ms-auto">
              <div class="progress-bar-single" style="width: 60%"></div>
            </div>
          </div>
          <div class="stat-content-single">
            <h3 class="stat-value-single">{{ stages_for_date|length|default:"0" }}</h3>
            <p class="stat-label-single">Today's Cases</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-3 col-6">
        <div class="stat-card-single zebra-stat-light">
          <div class="d-flex align-items-center mb-3">
            <div class="stat-icon-single">
              <i class="fas fa-clock-rotate-left"></i>
            </div>
            <div class="stat-progress-single ms-auto">
              <div class="progress-bar-single" style="width: 90%"></div>
            </div>
          </div>
          <div class="stat-content-single">
            <h3 class="stat-value-single">{{ user_cases|length|default:"0" }}</h3>
            <p class="stat-label-single">Your Cases</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Calendar Section -->
<div class="row g-4 mb-5 animate-on-scroll">
  <div class="col-12">
    <div class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-calendar-alt me-2"></i>Calendar View
        </h2>
      </div>
      <div class="section-content">
        <div id='calendar' class="dashboard-calendar"></div>
      </div>
    </div>
  </div>
</div>

<!-- Two Column Layout -->
<div class="row g-4 animate-on-scroll">
  <!-- Left Column: Stage Summary & Date Cases -->
  <div class="col-lg-8">
   

    <!-- Cases by Date -->
    <div class="dashboard-section">
      <div class="section-header">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <h2 class="section-title mb-3 mb-md-0">
            <i class="fas fa-calendar-check me-2"></i>
            {% if selected_date == today %}
              Today's Cases
            {% else %}
              Cases on {{ selected_date|date:"F d, Y" }}
            {% endif %}
          </h2>
          <form method="get" class="date-picker-form w-100 w-md-auto">
            <div class="input-group">
              <input type="date" name="date" class="form-control date-input" value="{{ selected_date|date:'Y-m-d'|default:today|date:'Y-m-d' }}">
              <button type="submit" class="btn btn-zebra-black">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="section-content">
        {% if stages_for_date %}
          <div class="table-responsive">
            <table class="dashboard-table">
              <thead>
                <tr>
                  <th class="text-nowrap">Court</th>
                  <th class="text-nowrap">Case Number</th>
                  <th class="text-nowrap">Case Name</th>
                  <th class="text-nowrap">Stage</th>
                  <th class="text-nowrap">Notes</th>
                </tr>
              </thead>
              <tbody>
                {% for stage in stages_for_date %}
                  <tr class="table-row-animate">
                    <td><span class="court-badge">{{ stage.case.court|default:"N/A" }}</span></td>
                    <td><strong>{{ stage.case.case_number|default:"N/A" }}</strong></td>
                    <td class="case-name-cell">{{ stage.case.case_name|default:"N/A" }}</td>
                    <td><span class="stage-tag">{{ stage.stage_name|default:"N/A" }}</span></td>
                    <td class="notes-cell">{{ stage.notes|truncatechars:50|default:"No notes" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state text-center py-5">
            <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
            <p class="text-muted">No cases scheduled for this date.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Column: Upcoming Stages & Quick Actions -->
  <div class="col-lg-4">
    <!-- Upcoming Stages -->
    <div class="dashboard-section mb-4 h-100 d-flex flex-column">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-clock me-2"></i>Upcoming Stages
        </h2>
      </div>
      <div class="section-content flex-grow-1">
        {% if upcoming_stages %}
          <div class="timeline">
            {% for stage in upcoming_stages %}
              <div class="timeline-item">
                <div class="timeline-date">
                  <span class="date-day">{{ stage.date|date:"d" }}</span>
                  <span class="date-month">{{ stage.date|date:"M" }}</span>
                </div>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1 me-3">
                      <h6 class="timeline-title mb-1">{{ stage.case.case_number|default:"N/A" }}</h6>
                      <p class="timeline-desc mb-0">{{ stage.case.case_name|truncatechars:40|default:"N/A" }}</p>
                    </div>
                    <span class="timeline-stage">{{ stage.stage_name|default:"N/A" }}</span>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state text-center py-5">
            <i class="fas fa-clock fa-3x mb-3 text-muted"></i>
            <p class="text-muted">No upcoming stages scheduled.</p>
          </div>
        {% endif %}
      </div>
    </div>

   

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    if (calendarEl) {
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        themeSystem: 'bootstrap5',
        events: function (fetchInfo, successCallback, failureCallback) {
          fetch('/upcoming_stages_json/?start=' + fetchInfo.startStr + '&end=' + fetchInfo.endStr)
            .then(response => response.json())
            .then(data => {
              const events = data.map(stage => ({
                title: stage.title || 'Stage',
                start: stage.start,
                url: stage.url,
                backgroundColor: '#000000',
                borderColor: '#ffffff',
                textColor: '#ffffff'
              }));
              successCallback(events);
            })
            .catch(error => {
              console.error('Error fetching stages:', error);
              successCallback([]);
            });
        },
        eventClick: function(info) {
          info.jsEvent.preventDefault();
          if (info.event.url) {
            window.location.href = info.event.url;
          }
        }
      });
      calendar.render();
      
      calendarEl.classList.add('calendar-loaded');
    }
  });

  function showAddStageModal() {
    alert('Select a case to add stage to');
  }

  document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.table-row-animate, .case-row');
    rows.forEach((row, index) => {
      row.style.animationDelay = `${index * 0.1}s`;
    });
  });
</script>
{% endblock %}